stages:
  - lint
  - test
  - build
  - build-desktop
  - deploy

variables:
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"

cache:
  paths:
    - .pip-cache/
    - .venv/

.python-setup: &python-setup
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - python -m venv .venv
    - source .venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt

# Linting stage
lint:
  <<: *python-setup
  stage: lint
  script:
    - pip install ruff mypy
    - ruff check src/
    - ruff format --check src/
  allow_failure: true

# Type checking
typecheck:
  <<: *python-setup
  stage: lint
  script:
    - pip install mypy
    - mypy src/ --ignore-missing-imports
  allow_failure: true

# Unit tests
test:
  <<: *python-setup
  stage: test
  script:
    - pip install pytest pytest-asyncio pytest-cov
    - pytest tests/ -v --cov=src --cov-report=term-missing --cov-report=xml
  coverage: '/TOTAL.*\s+(\d+%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

# Build Docker image
build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t trading-bot:${CI_COMMIT_SHORT_SHA} -f docker/Dockerfile .
    - docker tag trading-bot:${CI_COMMIT_SHORT_SHA} trading-bot:latest
  only:
    - main
    - develop

# ====================================
# Desktop App Builds (Tauri)
# ====================================

# Build macOS (ARM64 + Intel)
build-desktop-macos:
  stage: build-desktop
  tags:
    - macos
    - shared-runners
  before_script:
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source "$HOME/.cargo/env"
    - rustup target add x86_64-apple-darwin aarch64-apple-darwin
  script:
    - cd frontend && npm ci && npm run build && cd ..
    - cd desktop && npm ci
    - npm run build:mac-arm
    - npm run build:mac-intel
  artifacts:
    paths:
      - desktop/src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
      - desktop/src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
    - if: '$BUILD_DESKTOP == "true"'
    - when: manual
      allow_failure: true

# Build Windows (x64)
build-desktop-windows:
  stage: build-desktop
  tags:
    - windows
    - shared-runners
  before_script:
    - choco install rustup.install nodejs -y
    - rustup default stable-msvc
  script:
    - cd frontend
    - npm ci
    - npm run build
    - cd ../desktop
    - npm ci
    - npm run build:win
  artifacts:
    paths:
      - desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
      - desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
    - if: '$BUILD_DESKTOP == "true"'
    - when: manual
      allow_failure: true

# Build Linux (x64)
build-desktop-linux:
  stage: build-desktop
  image: rust:latest
  before_script:
    - apt-get update
    - apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libssl-dev libgtk-3-dev libayatana-appindicator3-dev nodejs npm
    - npm install -g n
    - n 20
  script:
    - cd frontend && npm ci && npm run build && cd ..
    - cd desktop && npm ci
    - npm run build:linux
  artifacts:
    paths:
      - desktop/src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/deb/*.deb
      - desktop/src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/appimage/*.AppImage
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
    - if: '$BUILD_DESKTOP == "true"'
    - when: manual
      allow_failure: true

# ====================================
# Deployment
# ====================================

# Deploy (manual trigger)
deploy:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Deploying trading bot..."
    - docker-compose -f xfactor-bot/docker-compose.yml up -d
  when: manual
  only:
    - main

